<html>
<head></head>

<body>
  <h1>IMask Core Demo</h1>
  <input type="text" id="input">
  <div>value: <span id="value"></span></div>
  <div>unmasked: <span id="unmasked"></span></div>
  <div contenteditable="true" id="ce"></div>

  <script src="dist/imask.js"></script>
  <!-- <script src="https://unpkg.com/imask"></script> -->
  <script type="text/javascript">
    const numberOpts = {
      mask: Number,
      thousandsSeparator: ' ',
      scale: 2,
      radix: '.',
      expose: true,
    };

    class NegativeNumberMask extends IMask.MaskedNumber {
      get typedValue () {
        return -Math.abs(super.typedValue);
      }
      set typedValue (value) {
        super.typedValue = Math.abs(value);
      }
    }

    function dispatchMaskIndex (value) {
      if (!value) return 0;
      else if (value.indexOf('-') === 0 || value.indexOf('-') === 1) return 2;
      else return 1;
    }

    const opts = {
      mask: [
        {
          mask: '',
        },
        {
          mask: '$num',
          blocks: {
            num: numberOpts,
          }
        },
        {
          mask: '{-}$num',
          blocks: {
            num: {
              ...numberOpts,
              mask: NegativeNumberMask,
              min: 0,
            }
          }
        }
      ],
      dispatch: (appended, dynamicMasked, flags, tail) => {
        const value = dynamicMasked.rawInputValue + appended + String(tail);
        const masked = dynamicMasked.compiledMasks[dispatchMaskIndex(value)];
        dynamicMasked.exposeMask = masked;
        return masked;
      }
    };

    const input = document.getElementById('input');
    var result = document.getElementById('value');
    var unmasked = document.getElementById('unmasked');
    var imask = IMask(input, opts).on('accept', () => {
      console.log('accept', imask.value, imask.unmaskedValue, imask.typedValue);
      result.innerHTML = imask.value;
      unmasked.innerHTML = imask.unmaskedValue;
    });

    input.addEventListener('keydown', e => console.log('keydown', e.isComposing));
    input.addEventListener('input', e => console.log('input', e.isComposing, e.inputType));
    input.addEventListener('compositionstart', e => console.log('compositionstart'));
    input.addEventListener('compositionend', e => console.log('compositionend'));

    // document.getElementById('input').addEventListener('focus', () => {
    //   imask.updateOptions({
    //     mask: mask.map((m) => ({
    //       ...m,
    //       lazy: false,
    //     })),
    //   });
    // });

    // document.getElementById('input').addEventListener('blur', () => {
    //   imask.updateOptions({
    //     mask: mask.map((m) => ({
    //       ...m,
    //       lazy: true,
    //     })),
    //   });
    // });

    // document.getElementById('input').addEventListener('blur', () => imask.updateOptions({lazy: true}));
    // document.getElementById('input').addEventListener('focus', () => imask.updateOptions({lazy: false}));
  </script>
</body>
</html>
